name: ğŸš€ Clarity Loop CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  REGISTRY: gcr.io
  IMAGE_NAME: clarity-loop-backend

jobs:
  # ğŸ” Code Quality & Linting
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“‹ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: ğŸ”§ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ Install Node.js dependencies
        run: npm ci

      - name: ğŸ” Run Ruff linting
        run: ruff check . --output-format=github

      - name: ğŸ¨ Check Black formatting
        run: black --check .

      - name: ğŸ“ Check import sorting
        run: ruff check . --select I --diff

      - name: ğŸ”’ Run security checks (Bandit)
        run: bandit -r clarity/ -f json -o bandit-report.json || true

      - name: ğŸ›¡ï¸ Check for vulnerabilities (Safety)
        run: safety check --json --output safety-report.json || true

      - name: ğŸ“š Lint documentation
        run: npm run lint:md

      - name: ğŸ¥ Check link health
        run: npm run check:links || true

      - name: ğŸ“Š Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ğŸ§ª Testing Suite
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“‹ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[test]

      - name: ğŸ”¥ Start Firebase Emulators
        run: |
          npm install -g firebase-tools
          firebase emulators:start --only firestore,auth,pubsub --project demo-test &
          sleep 10

      - name: ğŸ§ª Run unit tests
        env:
          TESTING: 1
          REDIS_URL: redis://localhost:6379
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          PUBSUB_EMULATOR_HOST: localhost:8085
        run: |
          pytest tests/unit/ -v --cov=clarity --cov-report=xml --cov-report=html

      - name: ğŸ”— Run integration tests
        env:
          TESTING: 1
          REDIS_URL: redis://localhost:6379
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          PUBSUB_EMULATOR_HOST: localhost:8085
        run: |
          pytest tests/integration/ -v --maxfail=5

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ğŸ” Type Checking
  type-check:
    name: ğŸ” Type Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“‹ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: ğŸ” Run MyPy type checking
        run: mypy clarity/ --strict

  # ğŸ¤– ML Model Tests
  ml-tests:
    name: ğŸ¤– ML Model Tests
    runs-on: ubuntu-latest
    needs: lint
    if: contains(github.event.head_commit.message, '[ml]') || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“‹ Install ML dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

      - name: ğŸ§  Test PAT model components
        run: pytest tests/ml/ -v -m "pat"

      - name: ğŸ”® Test Gemini integration
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: pytest tests/ml/ -v -m "gemini"

  # ğŸ—ï¸ Build & Security Scan
  build:
    name: ğŸ—ï¸ Build & Security Scan
    runs-on: ubuntu-latest
    needs: [test, type-check]
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ›¡ï¸ Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ğŸ“š Documentation Build
  docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“‹ Install documentation dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[docs]

      - name: ğŸ“š Build documentation
        run: mkdocs build --strict

      - name: ğŸ“¤ Upload documentation artifacts
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: site/

  # ğŸš€ Deploy to Google Cloud Run (Production)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ”§ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: ğŸ”§ Configure Docker to use gcloud
        run: gcloud auth configure-docker

      - name: ğŸ—ï¸ Build and push Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest

      - name: ğŸš€ Deploy to Cloud Run
        run: |
          gcloud run deploy clarity-loop-backend \
            --image ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --concurrency 1000 \
            --timeout 300 \
            --max-instances 100 \
            --set-env-vars="ENVIRONMENT=main" \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: ğŸ“¤ Deploy documentation
        if: success()
        run: mkdocs gh-deploy --force
